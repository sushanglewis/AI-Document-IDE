sequenceDiagram
    participant User
    participant WebSocket as WebSocket (main.py)
    participant RunLoop as _ws_run Loop
    participant Agent
    participant Recorder as TrajectoryRecorder
    participant EventHub as _traj_event_hub
    participant ManualLogic as Manual Bubble Logic

    User->>WebSocket: Connect /ws/agent/interactive/task
    WebSocket->>RunLoop: Start _ws_run
    
    rect rgb(240, 248, 255)
        note right of RunLoop: Async Task Start
        RunLoop->>Agent: agent.run()
        Agent->>Recorder: Record Step / LLM Interaction
        Recorder->>EventHub: Notify / Write File
    end

    loop Event Monitoring (Current Implementation)
        EventHub-->>RunLoop: Get Updated Trajectory Data
        RunLoop->>ManualLogic: Parse Steps & Interactions
        ManualLogic->>ManualLogic: Hardcoded formatting (No LakeView)
        ManualLogic->>WebSocket: Send JSON (Type: Bubble)
        WebSocket->>User: Display Bubble
    end