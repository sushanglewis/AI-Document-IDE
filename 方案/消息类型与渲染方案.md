# Trae Agent 消息类型与渲染方案

本文档详细梳理了 Trae Agent 运行时产生的所有消息类型（Case）、后端传递的数据结构、前端渲染逻辑及吐司通知（Toast）的展示方案。

## 1. 总体通信架构

-   **协议**: WebSocket
-   **URL**: `ws://localhost:8090/ws/agent/interactive/task`
-   **消息方向**: 双向（前端发送任务 -> 后端推送实时状态）
-   **核心机制**:
    -   **Step**: 包含完整的步骤信息（思考、工具调用、结果、输出），用于前端构建持久化的会话历史。
    -   **Bubble (Toast)**: 轻量级的实时通知，用于在界面右下角展示 Agent 的动态（思考过程、工具操作结果），支持去重和状态更新。

---

## 2. 消息类型 (Case) 详解

### Case 1: 思考 (Sequential Thinking)

Agent 在执行任务前的思考过程，通常包含对用户需求的分析、步骤规划等。

*   **触发条件**: 模型输出包含 `<thinking>` 标签或 `sequentialthinking` 内容。
*   **后端字段 (Payload)**:
    *   `type`: "bubble"
    *   `data.id`: `seq-{step_number}` (用于去重和更新)
    *   `data.role`: "agent"
    *   `data.content`: `🧠 sequentialthinking {step_number}：{content} [✅]`
    *   **非空字段**: `content` (思考内容), `step_number` (步骤号)
*   **状态更新**:
    *   **进行中**: 内容为 `🧠 sequentialthinking {n}：{content}`
    *   **已完成**: 当步骤状态不再是 "thinking" 时，后端会在内容末尾追加 `✅`。
*   **前端渲染**:
    *   **会话历史**: 显示为带 `🧠` 前缀的文本块。
    *   **吐司**: 显示持久化通知，内容实时更新。

### Case 2: 反思 (Reflection)

Agent 在执行完一步骤后的自我反思，总结当前进展和下一步计划。

*   **触发条件**: 步骤数据中包含 `reflection` 字段。
*   **后端字段 (Payload)**:
    *   `type`: "bubble"
    *   `data.id`: `seq-reflect-{step_number}`
    *   `data.role`: "agent"
    *   `data.content`: `🧠 sequentialthinking {step_number}：{reflection} [✅]`
    *   **非空字段**: `reflection` (反思内容)
*   **状态更新**: 同“思考”Case，完成后追加 `✅`。
*   **前端渲染**: 与“思考”一致。

### Case 3: 工具调用 (Tool Call) - 进行中

Agent 决定调用某个工具（如读取文件、执行命令）。

*   **触发条件**: 模型输出工具调用指令。
*   **后端字段 (Payload)**:
    *   `type`: "bubble"
    *   `data.id`: `tc-{step_number}-{call_id}`
    *   `data.role`: "agent"
    *   `data.content`: `🔧{tool_name} {arguments}`
    *   **非空字段**: `name` (工具名), `arguments` (参数 JSON 字符串), `call_id`
*   **前端渲染**:
    *   **会话历史**: 显示为 `🔧 {tool_name} {args}`。
    *   **吐司**: 显示工具名和参数摘要。

### Case 4: 工具调用 (Tool Call) - 已完成 (带结果)

工具执行完毕，产生结果（成功或失败）。为了减少消息干扰，**结果不单独发送新吐司，而是更新原有的工具调用吐司**。

*   **触发条件**: 工具执行完成，产生 `tool_results`。
*   **后端字段 (Payload)**:
    *   `type`: "bubble"
    *   `data.id`: `tc-{step_number}-{call_id}` (ID 保持不变，以触发更新)
    *   `data.role`: "agent"
    *   `data.content`: `🔧{tool_name} {arguments} ✅` (成功) 或 `❌` (失败)
    *   **非空字段**: 同上，新增 `success` 状态判断。
*   **前端渲染**:
    *   **会话历史**: 原消息后追加 `✅` 或 `❌`。
    *   **吐司**: 原吐司内容更新，追加状态图标。

### Case 5: Agent 最终输出 (Agent Output)

Agent 完成任务或需要与用户对话时的直接回复。

*   **触发条件**: 模型输出普通文本（非思考、非工具调用）。
*   **后端字段 (Payload)**:
    *   `type`: "step" (作为 Step 的一部分发送，不单独触发 Bubble，以免重复)
    *   `data.message_units`: 包含 `type="agent_output"` 的单元。
*   **前端渲染**:
    *   **会话历史**: 渲染为 Markdown 文本。
    *   **吐司**: 不显示（通常内容较长，适合在主聊天窗口阅读）。

### Case 6: 错误 (Error)

执行过程中发生的系统级错误或异常。

*   **触发条件**: 捕获到 Exception。
*   **后端字段 (Payload)**:
    *   `type`: "error"
    *   `data.message`: 错误详情字符串。
*   **前端渲染**:
    *   **吐司**: 红色错误提示 `Toast.error`。

### Case 7: CKG 工具调用 (CKG Tool Call)

针对代码知识图谱 (CKG) 工具的特定优化，提取用户高价值信息进行展示。

*   **触发条件**: 调用 `ckg` 工具。
*   **用户价值信息**:
    *   **search_function**: 关注 `identifier` (函数名)。
    *   **search_class**: 关注 `identifier` (类名)。
    *   **search_class_method**: 关注 `identifier` (方法名)。
*   **后端处理 (main.py)**:
    *   在构建 Bubble 内容时，检测 `tool_name == 'ckg'`。
    *   解析 `arguments`，提取 `command` 和 `identifier`。
    *   格式化 `content` 为: `🔧 ckg {command}: {identifier}` (去除冗余的 JSON 符号和 path 参数)。
*   **前端渲染**:
    *   **吐司**: 显示精简后的 `content`，例如 `🔧 ckg search_function: get_user_info`。
    *   **结果更新**: 任务完成后追加 `✅` 或 `❌`。

---

## 3. 前端渲染策略 (App.tsx)

### 3.1 会话历史 (Session Messages)
前端接收 `type: "step"` 消息，解析 `message_units` 数组：
-   **去重**: 使用 `stepId` (步骤号) 作为 Key，对同一步骤的消息进行 **Upsert (更新或插入)** 操作。
-   **格式化**:
    -   `think` -> `🧠 {content} ✅`
    -   `tool_call` -> `🔧 {name} {args}`
    -   `tool_result` -> 寻找前一个 `tool_call` 并追加 `✅` / `❌`。
    -   `agent_output` -> 直接显示 Markdown。

### 3.2 吐司通知 (Toasts)
前端接收 `type: "bubble"` 消息：
-   **组件**: 使用 `Sonner` 库。
-   **配置**:
    -   `duration: Infinity` (持久化，直到用户关闭或页面刷新)
    -   `closeButton: true` (显示关闭按钮)
    -   `position: "bottom-right"` (右下角)
    -   `expand: true` (展开显示)
-   **去重逻辑**:
    -   利用 `bubbleId` (`data.id`)。
    -   如果 `bubbleId` 已存在，则**更新**现有吐司的内容（例如追加 `✅`）。
    -   如果 `bubbleId` 不存在，则**追加**新吐司到列表底部。

## 4. 关键优化点

1.  **消息去重**: 后端缓存 `last_step_payloads`，仅在步骤内容发生实质变化时推送，避免刷屏。
2.  **视觉降噪**: 工具结果不再单独占一行通知，而是合并到调用行，通过 Emoji 直观表达状态。
3.  **信息密度**: 移除无用的字段名（如 "工具调用："），直接展示核心信息（工具名、参数、状态）。
