# Trae Agent 基础反思机制改造方案

## 现状与定位
- 覆写位置：`trae-agent/trae_agent/agent/trae_agent.py:196-199` 将 `reflect_on_result` 返回 `None`，导致反思被禁用。
- 基类默认反思：`trae-agent/trae_agent/agent/base_agent.py:253-265` 会对失败的工具执行结果生成简要提示文本，并在管线中作为 `assistant` 消息注入（`base_agent.py:354-364`）。

## 改造内容
- 恢复基础反思：将 `TraeAgent.reflect_on_result` 改为调用基类实现，代码位置与改动：`trae-agent/trae_agent/agent/trae_agent.py:196-199`。
  - 修改后逻辑：当存在失败的 `ToolResult` 时，自动生成包含错误摘要的反思文本并注入当前步骤消息；无失败则不反思。

## 生效路径与验证
- 触发点：`base_agent._tool_call_handler` 在工具执行后设置 `step.tool_results` 并调用 `reflect_on_result`（`trae-agent/trae_agent/agent/base_agent.py:343-364`）。
- 消息注入：反思非空时，追加一条 `assistant` 消息（`base_agent.py:354-364`）。
- 轨迹记录：反思文本记录于 `step.reflection`，并随步骤写入轨迹文件（`base_agent.py:313-325`）。

## 验收标准
- 有失败的工具调用时：轨迹中的对应步骤包含非空 `reflection` 字段，内容为失败原因摘要。
- 全部工具成功时：不注入反思消息，流程简洁。
- 不引入并行或其他管线行为改变。

## 后续扩展（非本次）
- 质量审查驱动的反思：在开启质量审查时，新增 `reflect_on_quality_results(review_results)` 分支，仅基于审查结果生成反思。
- 领域化提示：在基础反思的错误短语上增加针对性建议（如路径错误提示查看 `view`、替换失败建议增加上下文行等）。

## 相关代码引用
- `trae-agent/trae_agent/agent/trae_agent.py:196-199`
- `trae-agent/trae_agent/agent/base_agent.py:253-265`
- `trae-agent/trae_agent/agent/base_agent.py:343-364`